version: "3.9"

services:
  postgres:
    build:
      context: .
      dockerfile: docker_definitions/postgres/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-HealthMan}_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # WSL/LXC: Reduce connection overhead
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - ./docker_data/postgres:/var/lib/postgresql/data
    networks:
      - healthnet
    shm_size: 256mb
    # WSL/LXC compatibility: shared memory for PostgreSQL
    ulimits:
      memlock: -1
    tmpfs:
      - /tmp
    # WSL/LXC: Use host network for better compatibility (optional, comment out if not needed)
    # network_mode: host

  redis:
    build:
      context: .
      dockerfile: docker_definitions/redis/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-HealthMan}_redis
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    restart: unless-stopped
    volumes:
      - ./docker_data/redis:/data
    networks:
      - healthnet

  wger:
    build:
      context: .
      dockerfile: docker_definitions/wger/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-HealthMan}_wger
    restart: unless-stopped
    environment:
      - DJANGO_SETTINGS_MODULE=wger.settings
      - DEBUG=${WGER_DEBUG}
      - SECRET_KEY=${WGER_SECRET_KEY}
      - ALLOWED_HOSTS=${WGER_ALLOWED_HOSTS}
      - DB_HOST=postgres
      - DB_NAME=${POSTGRES_DB}
      - DB_USER=${POSTGRES_USER}
      - DB_PASS=${POSTGRES_PASSWORD}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      # SMTP Email Configuration
      - EMAIL_HOST=${SMTP_HOST:-}
      - EMAIL_PORT=${SMTP_PORT:-587}
      - EMAIL_HOST_USER=${SMTP_USER:-}
      - EMAIL_HOST_PASSWORD=${SMTP_PASSWORD:-}
      - EMAIL_USE_TLS=${SMTP_USE_TLS:-true}
      - EMAIL_USE_SSL=${SMTP_USE_SSL:-false}
      - DEFAULT_FROM_EMAIL=${SMTP_FROM_EMAIL:-}
    volumes:
      - ./docker_data/wger:/home/wger/data
      - ./docker_configs/wger_extensions/fasting_extension:/home/wger/src/fasting_extension
      - ./docker_configs/wger_extensions/fasting_extension/wger_overrides/settings_extra.py:/home/wger/src/wger/settings_extra.py
      - ./docker_configs/wger_extensions/fasting_extension/wger_overrides/urls_extra.py:/home/wger/src/wger/urls_extra.py
    networks:
      - healthnet
    expose:
      - "8080"
    # WSL/LXC: Wait for postgres to be ready instead of healthcheck
    depends_on:
      - postgres
      - redis

  tandoor:
    build:
      context: .
      dockerfile: docker_definitions/tandoor/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-HealthMan}_tandoor
    restart: unless-stopped
    environment:
      - SECRET_KEY=${TANDOOR_SECRET_KEY}
      - DB_ENGINE=django.db.backends.postgresql
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - ALLOWED_HOSTS=*
      # SMTP Email Configuration
      - EMAIL_HOST=${SMTP_HOST:-}
      - EMAIL_PORT=${SMTP_PORT:-587}
      - EMAIL_HOST_USER=${SMTP_USER:-}
      - EMAIL_HOST_PASSWORD=${SMTP_PASSWORD:-}
      - EMAIL_USE_TLS=${SMTP_USE_TLS:-true}
      - EMAIL_USE_SSL=${SMTP_USE_SSL:-false}
      - DEFAULT_FROM_EMAIL=${SMTP_FROM_EMAIL:-}
    volumes:
      - ./docker_data/tandoor:/opt/recipes/mediafiles
    networks:
      - healthnet
    expose:
      - "8081"
    depends_on:
      - postgres

  n8n:
    build:
      context: .
      dockerfile: docker_definitions/n8n/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-HealthMan}_n8n
    restart: unless-stopped
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${TZ:-UTC}
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - EXECUTIONS_PROCESS=main
      # SSL and URL Configuration
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://flow.healthman.breyninc.co.za}
      - N8N_HOST=${FLOW_DOMAIN:-flow.healthman.breyninc.co.za}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-https}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-}
      # CORS Configuration (for webhook access from external domains)
      - N8N_CORS_ORIGIN=${N8N_CORS_ORIGIN:-*}
      - N8N_WEBHOOK_CORS=${N8N_WEBHOOK_CORS:-true}
      # WSL/LXC compatibility
      - N8N_METRICS=false
      - N8N_DISABLE_PRODUCTION_MAIN_PROCESS=false
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168
    volumes:
      - ./docker_data/n8n:/home/node/.n8n
      - ./docker_configs/n8n_workflows:/workflows
    networks:
      - healthnet
    expose:
      - "5678"
    depends_on:
      - postgres
      - redis

  grafana:
    build:
      context: .
      dockerfile: docker_definitions/grafana/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-HealthMan}_grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=${DASH_DOMAIN:-dash.healthman.breyninc.co.za}
      - GF_SERVER_HTTP_PORT=3000
      # WSL/LXC compatibility
      - GF_INSTALL_PLUGINS=
      # SMTP Email Configuration
      - GF_SMTP_ENABLED=${SMTP_HOST:+true}
      - GF_SMTP_HOST=${SMTP_HOST:-}
      - GF_SMTP_PORT=${SMTP_PORT:-587}
      - GF_SMTP_USER=${SMTP_USER:-}
      - GF_SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - GF_SMTP_SKIP_VERIFY=${SMTP_SKIP_VERIFY:-false}
      - GF_SMTP_FROM_ADDRESS=${SMTP_FROM_EMAIL:-}
      - GF_SMTP_FROM_NAME=Grafana
    volumes:
      - ./docker_data/grafana:/var/lib/grafana
      - ./docker_configs/grafana/provisioning:/etc/grafana/provisioning
    networks:
      - healthnet
    expose:
      - "3000"
    mem_limit: 512m
    depends_on:
      - postgres

  caddy:
    build:
      context: .
      dockerfile: docker_definitions/caddy/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-HealthMan}_caddy
    restart: unless-stopped
    environment:
      - CADDY_ADMIN_EMAIL=${CADDY_ADMIN_EMAIL}
    volumes:
      - ./docker_configs/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./docker_data/caddy:/data
      - ./docker_data/caddy_config:/config
    ports:
      - "80:80"
      - "443:443"
    networks:
      - healthnet
    depends_on:
      - wger
      - tandoor
      - n8n
      - grafana

networks:
  healthnet:
    driver: bridge
    # WSL/LXC: Use host network mode for better compatibility (alternative to above)
    # Uncomment the line below and comment out driver: bridge if experiencing network issues
    # driver: host

